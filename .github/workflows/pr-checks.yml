name: PR Checks

on:
    pull_request:
        branches:
            - main
        paths:
            - "backend/**"
            - "auth-service/**"
            - "frontend/app/**"
            - ".github/workflows/**"
            - "docker-compose.yml"
            - "**/Dockerfile"

jobs:
    lint-frontend:
        name: Lint Frontend Services
        runs-on: ubuntu-latest
        strategy:
            matrix:
                service:
                    - name: auth-service
                      path: auth-service
                    - name: frontend
                      path: frontend/app
                    - name: backend
                      path: backend
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: ${{ matrix.service.path }}/package-lock.json

            - name: Install dependencies
              working-directory: ${{ matrix.service.path }}
              run: npm ci

            - name: Run ESLint
              working-directory: ${{ matrix.service.path }}
              run: npm run lint
              continue-on-error: false

    build-docker-images:
        name: Build Docker Images
        runs-on: ubuntu-latest
        needs: [lint-frontend]
        strategy:
            fail-fast: false
            matrix:
                service:
                    - name: backend
                      context: ./backend
                      dockerfile: ./backend/Dockerfile
                    - name: auth-service
                      context: ./auth-service
                      dockerfile: ./auth-service/Dockerfile
                    - name: frontend
                      context: ./frontend/app
                      dockerfile: ./frontend/app/Dockerfile
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Build Docker image
              run: |
                  set -e
                  echo "Building Docker image for ${{ matrix.service.name }}"
                  echo "Context: ${{ matrix.service.context }}"
                  echo "Dockerfile: ${{ matrix.service.dockerfile }}"
                  docker build \
                    -f ${{ matrix.service.dockerfile }} \
                    -t portfolio-${{ matrix.service.name }}:pr-check \
                    ${{ matrix.service.context }}
                  echo "Build completed successfully"
                  echo ""
                  echo "Verifying image was created:"
                  docker images portfolio-${{ matrix.service.name }}:pr-check

            - name: Verify image exists
              run: |
                  IMAGE_NAME="portfolio-${{ matrix.service.name }}:pr-check"
                  echo "Verifying image: $IMAGE_NAME"
                  if docker image inspect "$IMAGE_NAME" > /dev/null 2>&1; then
                    echo "✓ Image verified successfully"
                    docker images "$IMAGE_NAME"
                  else
                    echo "✗ Image verification failed"
                    echo "Available images:"
                    docker images
                    exit 1
                  fi
